(ns draw-github-contributions.core-test
  (:require [clojure.test :refer :all]
            [draw-github-contributions.core :refer :all]
            [clojure.spec.alpha :as spec]
            [clojure.test.check.generators :as check.gen])
  (:import (java.time LocalDate)))

(def test-config
  {:config/committer {:committer/name "Fake Contribution"
                      :committer/email "piotr-yuxuan@users.noreply.github.com"}
   :config/number-of-commits 150
   :config/bottom-right-hand-corner-date [2018 9 22]
   :config/image-path "resources/contributions.png"
   :config/repository-path "../fake-contributions"})

(def expected-grid-elements
  [["2017-09-24" 0]
   ["2017-09-25" 0]
   ["2017-09-26" 0]
   ["2017-09-27" 0]
   ["2017-09-28" 0]
   ["2017-09-29" 0]
   ["2017-09-30" 0]
   ["2017-10-01" 0]
   ["2017-10-02" 0]
   ["2017-10-03" 0]
   ["2017-10-04" 0]
   ["2017-10-05" 0]
   ["2017-10-06" 0]
   ["2017-10-07" 0]
   ["2017-10-08" 0]
   ["2017-10-09" 0]
   ["2017-10-10" 0]
   ["2017-10-11" 0]
   ["2017-10-12" 0]
   ["2017-10-13" 0]
   ["2017-10-14" 0]
   ["2017-10-15" 0]
   ["2017-10-16" 0]
   ["2017-10-17" 150]
   ["2017-10-18" 150]
   ["2017-10-19" 150]
   ["2017-10-20" 0]
   ["2017-10-21" 0]
   ["2017-10-22" 0]
   ["2017-10-23" 150]
   ["2017-10-24" 0]
   ["2017-10-25" 0]
   ["2017-10-26" 0]
   ["2017-10-27" 150]
   ["2017-10-28" 0]
   ["2017-10-29" 0]
   ["2017-10-30" 0]
   ["2017-10-31" 0]
   ["2017-11-01" 0]
   ["2017-11-02" 0]
   ["2017-11-03" 150]
   ["2017-11-04" 0]
   ["2017-11-05" 0]
   ["2017-11-06" 0]
   ["2017-11-07" 0]
   ["2017-11-08" 0]
   ["2017-11-09" 150]
   ["2017-11-10" 0]
   ["2017-11-11" 0]
   ["2017-11-12" 0]
   ["2017-11-13" 0]
   ["2017-11-14" 0]
   ["2017-11-15" 150]
   ["2017-11-16" 150]
   ["2017-11-17" 0]
   ["2017-11-18" 0]
   ["2017-11-19" 0]
   ["2017-11-20" 0]
   ["2017-11-21" 0]
   ["2017-11-22" 150]
   ["2017-11-23" 0]
   ["2017-11-24" 0]
   ["2017-11-25" 0]
   ["2017-11-26" 0]
   ["2017-11-27" 0]
   ["2017-11-28" 0]
   ["2017-11-29" 150]
   ["2017-11-30" 0]
   ["2017-12-01" 0]
   ["2017-12-02" 0]
   ["2017-12-03" 0]
   ["2017-12-04" 0]
   ["2017-12-05" 0]
   ["2017-12-06" 150]
   ["2017-12-07" 0]
   ["2017-12-08" 0]
   ["2017-12-09" 0]
   ["2017-12-10" 0]
   ["2017-12-11" 150]
   ["2017-12-12" 0]
   ["2017-12-13" 0]
   ["2017-12-14" 0]
   ["2017-12-15" 150]
   ["2017-12-16" 0]
   ["2017-12-17" 0]
   ["2017-12-18" 0]
   ["2017-12-19" 150]
   ["2017-12-20" 0]
   ["2017-12-21" 150]
   ["2017-12-22" 0]
   ["2017-12-23" 0]
   ["2017-12-24" 0]
   ["2017-12-25" 0]
   ["2017-12-26" 0]
   ["2017-12-27" 150]
   ["2017-12-28" 0]
   ["2017-12-29" 0]
   ["2017-12-30" 0]
   ["2017-12-31" 0]
   ["2018-01-01" 0]
   ["2018-01-02" 0]
   ["2018-01-03" 0]
   ["2018-01-04" 0]
   ["2018-01-05" 0]
   ["2018-01-06" 0]
   ["2018-01-07" 0]
   ["2018-01-08" 0]
   ["2018-01-09" 150]
   ["2018-01-10" 150]
   ["2018-01-11" 150]
   ["2018-01-12" 0]
   ["2018-01-13" 0]
   ["2018-01-14" 0]
   ["2018-01-15" 150]
   ["2018-01-16" 0]
   ["2018-01-17" 0]
   ["2018-01-18" 0]
   ["2018-01-19" 150]
   ["2018-01-20" 0]
   ["2018-01-21" 0]
   ["2018-01-22" 150]
   ["2018-01-23" 0]
   ["2018-01-24" 150]
   ["2018-01-25" 0]
   ["2018-01-26" 150]
   ["2018-01-27" 0]
   ["2018-01-28" 0]
   ["2018-01-29" 0]
   ["2018-01-30" 150]
   ["2018-01-31" 0]
   ["2018-02-01" 0]
   ["2018-02-02" 150]
   ["2018-02-03" 0]
   ["2018-02-04" 0]
   ["2018-02-05" 0]
   ["2018-02-06" 0]
   ["2018-02-07" 0]
   ["2018-02-08" 0]
   ["2018-02-09" 0]
   ["2018-02-10" 0]
   ["2018-02-11" 0]
   ["2018-02-12" 0]
   ["2018-02-13" 0]
   ["2018-02-14" 0]
   ["2018-02-15" 0]
   ["2018-02-16" 0]
   ["2018-02-17" 0]
   ["2018-02-18" 0]
   ["2018-02-19" 0]
   ["2018-02-20" 150]
   ["2018-02-21" 150]
   ["2018-02-22" 150]
   ["2018-02-23" 150]
   ["2018-02-24" 0]
   ["2018-02-25" 0]
   ["2018-02-26" 150]
   ["2018-02-27" 0]
   ["2018-02-28" 150]
   ["2018-03-01" 0]
   ["2018-03-02" 0]
   ["2018-03-03" 0]
   ["2018-03-04" 0]
   ["2018-03-05" 0]
   ["2018-03-06" 150]
   ["2018-03-07" 150]
   ["2018-03-08" 150]
   ["2018-03-09" 150]
   ["2018-03-10" 0]
   ["2018-03-11" 0]
   ["2018-03-12" 0]
   ["2018-03-13" 0]
   ["2018-03-14" 0]
   ["2018-03-15" 0]
   ["2018-03-16" 0]
   ["2018-03-17" 0]
   ["2018-03-18" 0]
   ["2018-03-19" 150]
   ["2018-03-20" 150]
   ["2018-03-21" 150]
   ["2018-03-22" 150]
   ["2018-03-23" 150]
   ["2018-03-24" 0]
   ["2018-03-25" 0]
   ["2018-03-26" 150]
   ["2018-03-27" 0]
   ["2018-03-28" 0]
   ["2018-03-29" 0]
   ["2018-03-30" 150]
   ["2018-03-31" 0]
   ["2018-04-01" 0]
   ["2018-04-02" 0]
   ["2018-04-03" 150]
   ["2018-04-04" 150]
   ["2018-04-05" 150]
   ["2018-04-06" 0]
   ["2018-04-07" 0]
   ["2018-04-08" 0]
   ["2018-04-09" 0]
   ["2018-04-10" 0]
   ["2018-04-11" 0]
   ["2018-04-12" 0]
   ["2018-04-13" 0]
   ["2018-04-14" 0]
   ["2018-04-15" 0]
   ["2018-04-16" 150]
   ["2018-04-17" 150]
   ["2018-04-18" 150]
   ["2018-04-19" 150]
   ["2018-04-20" 150]
   ["2018-04-21" 0]
   ["2018-04-22" 0]
   ["2018-04-23" 0]
   ["2018-04-24" 0]
   ["2018-04-25" 0]
   ["2018-04-26" 0]
   ["2018-04-27" 0]
   ["2018-04-28" 0]
   ["2018-04-29" 0]
   ["2018-04-30" 150]
   ["2018-05-01" 150]
   ["2018-05-02" 150]
   ["2018-05-03" 150]
   ["2018-05-04" 150]
   ["2018-05-05" 0]
   ["2018-05-06" 0]
   ["2018-05-07" 0]
   ["2018-05-08" 0]
   ["2018-05-09" 150]
   ["2018-05-10" 0]
   ["2018-05-11" 0]
   ["2018-05-12" 0]
   ["2018-05-13" 0]
   ["2018-05-14" 0]
   ["2018-05-15" 150]
   ["2018-05-16" 0]
   ["2018-05-17" 150]
   ["2018-05-18" 0]
   ["2018-05-19" 0]
   ["2018-05-20" 0]
   ["2018-05-21" 150]
   ["2018-05-22" 0]
   ["2018-05-23" 0]
   ["2018-05-24" 0]
   ["2018-05-25" 150]
   ["2018-05-26" 0]
   ["2018-05-27" 0]
   ["2018-05-28" 0]
   ["2018-05-29" 0]
   ["2018-05-30" 0]
   ["2018-05-31" 0]
   ["2018-06-01" 0]
   ["2018-06-02" 0]
   ["2018-06-03" 0]
   ["2018-06-04" 150]
   ["2018-06-05" 0]
   ["2018-06-06" 0]
   ["2018-06-07" 0]
   ["2018-06-08" 0]
   ["2018-06-09" 0]
   ["2018-06-10" 0]
   ["2018-06-11" 150]
   ["2018-06-12" 150]
   ["2018-06-13" 150]
   ["2018-06-14" 150]
   ["2018-06-15" 150]
   ["2018-06-16" 0]
   ["2018-06-17" 0]
   ["2018-06-18" 150]
   ["2018-06-19" 0]
   ["2018-06-20" 0]
   ["2018-06-21" 0]
   ["2018-06-22" 0]
   ["2018-06-23" 0]
   ["2018-06-24" 0]
   ["2018-06-25" 0]
   ["2018-06-26" 0]
   ["2018-06-27" 0]
   ["2018-06-28" 0]
   ["2018-06-29" 0]
   ["2018-06-30" 0]
   ["2018-07-01" 0]
   ["2018-07-02" 150]
   ["2018-07-03" 150]
   ["2018-07-04" 150]
   ["2018-07-05" 150]
   ["2018-07-06" 150]
   ["2018-07-07" 0]
   ["2018-07-08" 0]
   ["2018-07-09" 150]
   ["2018-07-10" 0]
   ["2018-07-11" 150]
   ["2018-07-12" 0]
   ["2018-07-13" 150]
   ["2018-07-14" 0]
   ["2018-07-15" 0]
   ["2018-07-16" 150]
   ["2018-07-17" 0]
   ["2018-07-18" 0]
   ["2018-07-19" 0]
   ["2018-07-20" 150]
   ["2018-07-21" 0]
   ["2018-07-22" 0]
   ["2018-07-23" 0]
   ["2018-07-24" 0]
   ["2018-07-25" 0]
   ["2018-07-26" 0]
   ["2018-07-27" 0]
   ["2018-07-28" 0]
   ["2018-07-29" 0]
   ["2018-07-30" 150]
   ["2018-07-31" 150]
   ["2018-08-01" 150]
   ["2018-08-02" 150]
   ["2018-08-03" 150]
   ["2018-08-04" 0]
   ["2018-08-05" 0]
   ["2018-08-06" 150]
   ["2018-08-07" 0]
   ["2018-08-08" 150]
   ["2018-08-09" 0]
   ["2018-08-10" 150]
   ["2018-08-11" 0]
   ["2018-08-12" 0]
   ["2018-08-13" 150]
   ["2018-08-14" 0]
   ["2018-08-15" 0]
   ["2018-08-16" 0]
   ["2018-08-17" 150]
   ["2018-08-18" 0]
   ["2018-08-19" 0]
   ["2018-08-20" 0]
   ["2018-08-21" 0]
   ["2018-08-22" 0]
   ["2018-08-23" 0]
   ["2018-08-24" 0]
   ["2018-08-25" 0]
   ["2018-08-26" 0]
   ["2018-08-27" 150]
   ["2018-08-28" 150]
   ["2018-08-29" 150]
   ["2018-08-30" 150]
   ["2018-08-31" 0]
   ["2018-09-01" 0]
   ["2018-09-02" 0]
   ["2018-09-03" 0]
   ["2018-09-04" 0]
   ["2018-09-05" 0]
   ["2018-09-06" 0]
   ["2018-09-07" 150]
   ["2018-09-08" 0]
   ["2018-09-09" 0]
   ["2018-09-10" 150]
   ["2018-09-11" 150]
   ["2018-09-12" 150]
   ["2018-09-13" 150]
   ["2018-09-14" 0]
   ["2018-09-15" 0]
   ["2018-09-16" 0]
   ["2018-09-17" 0]
   ["2018-09-18" 0]
   ["2018-09-19" 0]
   ["2018-09-20" 0]
   ["2018-09-21" 0]
   ["2018-09-22" 0]])

(def strict-pos-int? #(and (number? %) (or (zero? %) (pos-int? %))))
(def local-date? #(instance? LocalDate %))

(spec/def :commits/number strict-pos-int?)
(spec/def :commits/date local-date?)
(spec/def ::grid-element (spec/keys :req [:commits/number
                                          :commits/date]))
(spec/def ::no-twice-same-date (fn no-twice-same-date [grid-elements]
                                 (->> grid-elements
                                      (group-by :commits/date)
                                      vals
                                      (map count)
                                      set
                                      (= #{1}))))
(spec/def ::grid (spec/and #(= number-of-weeks (count %))
                           (spec/coll-of (spec/and (spec/coll-of ::grid-element)
                                                   ::no-twice-same-date
                                                   #(= number-of-weekdays (count %))))))
(spec/def ::image-pixel #{[-1 -1 -1] [0 0 0]})
(spec/def :committer/name string?)
(spec/def :committer/email string?)
(spec/def :config/committer (spec/keys :req [:committer/name :committer/email]))
(spec/def :config/number-of-commits
  (spec/with-gen
    strict-pos-int?
    #(do check.gen/nat)))
(spec/def :config/bottom-right-hand-corner-date (spec/and (spec/coll-of pos-int?)
                                                          #(= 3 (count %))
                                                          (fn [[^int year ^int month ^int day-of-month]]
                                                            (LocalDate/of year month day-of-month))))

(spec/def :config/image-path string?)
(spec/def :config/repository-path string?)
(spec/def :config/side-effects? boolean?)

(spec/def ::config (spec/keys :req [:config/number-of-commits
                                    :config/bottom-right-hand-corner-date
                                    :config/image-path]
                              :opt [:config/committer
                                    :config/repository-path
                                    :config/side-effects?]))

(deftest grid-elements-generation
  (testing "test config is valid"
    (is (spec/valid? ::config test-config)))

  (testing "default config is valid"
    (is (spec/valid? ::config default-config)))

  (testing "get-image-pixels result"
    (testing "is valid"
      (is (spec/valid? (spec/coll-of ::image-pixel)
                       (get-image-pixels (:config/image-path test-config)))))

    (testing "length is valid"
      (is (= (count (get-image-pixels (:config/image-path test-config)))
             (* number-of-weeks
                number-of-weekdays)))))

  (testing "fill-commits-numbers")
  ;; (fill-commits-number number-of-commits)
  tranpose-data-representation
  ;; (fill-commits-dates number-of-weeks number-of-weekdays reference-date)

  (testing "->grid-elements"
    (testing "is valid"
      (is (spec/valid? ::grid (partition number-of-weekdays (->grid-elements test-config)))))

    (testing "is correct"
      (is (= (vec (map (juxt (comp str :commits/date) :commits/number) (->grid-elements test-config)))
             expected-grid-elements)))))
